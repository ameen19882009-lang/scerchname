<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>بحث بالأسماء (CSV صغير)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --accent:#2563eb; --bg:#ffffff; --fg:#111827; --muted:#6b7280;
      --border:#e5e7eb; --hover:#f9fafb; --head:#1f2937; --headfg:#ffffff;
      --row1:#ffffff; --row2:#fcfcff;
    }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", Tahoma, Arial, sans-serif; background: var(--bg); color: var(--fg); margin: 0; padding: 24px; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { margin: 0 0 12px; font-size: 1.35rem; }
    .help { color: var(--muted); margin-bottom: 16px; }
    .bar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    input[type="text"]{ flex:1 1 420px; padding:10px 12px; border:1px solid var(--border); border-radius:8px; font-size:0.95rem; }
    button{ background:var(--accent); color:#fff; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; font-size:0.95rem;}
    button.secondary{ background:#f3f4f6; color:#111827; border:1px solid var(--border); }
    .status{ font-size:0.9rem; color: var(--muted); margin:8px 0 16px; }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:0.8rem; }
    .error{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; padding:12px; border-radius:8px; margin-bottom:10px; }

    .table-wrap { overflow-x:auto; border:1px solid var(--border); border-radius:10px; }
    table{ width:100%; border-collapse:separate; border-spacing:0; background:#fff; }
    thead th{
      position: sticky; top: 0; z-index: 1;
      background: var(--head); color: var(--headfg);
      padding: 12px 10px; text-align:right; font-weight:600; user-select:none; cursor:pointer;
      border-bottom:1px solid var(--border);
    }
    thead th:first-child { border-top-right-radius:10px; }
    thead th:last-child  { border-top-left-radius:10px; }
    tbody td{
      padding: 10px; vertical-align:top; border-bottom:1px solid var(--border);
      border-inline-start: 1px solid var(--border);
      background: var(--row1);
      word-break: break-word;
    }
    tbody tr:nth-child(even) td { background: var(--row2); }
    tbody tr:hover td { background: var(--hover); }
    tbody tr td:first-child { border-inline-start: none; }
    .sr{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }
    .no-results { padding: 10px; color: #7f1d1d; background:#fff7ed; border:1px solid #fde68a; border-radius:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>بحث بالأسماء (CSV صغير)</h1>
    <p class="help">
      اكتب اسم ثنائي/جزئي. البحث يتم على عمود <code>الاسم</code> تحديدًا، ويعرض فقط النتائج المطابقة.
      إذا البحث فارغ لن تُعرض بيانات. انقر على عنوان أي عمود للفرز.
    </p>

    <div id="alerts"></div>

    <div class="bar">
      <label for="q" class="sr">ابحث بالاسم</label>
      <input id="q" type="text" placeholder="ابحث بالاسم (مثال: علي محمد)" autocomplete="off" />
      <button id="btnSearch" type="button">بحث</button>
      <button id="btnClear" class="secondary" type="button">مسح</button>
      <span id="count" class="badge" aria-live="polite">—</span>
    </div>

    <div id="feedback" class="status"></div>

    <div class="table-wrap">
      <table id="grid" aria-live="polite">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="emptyMsg" class="no-results" style="display:none">لا توجد نتائج مطابقة.</div>
  </div>

  <script>
    /* ===== مسار الملف (بنفس الحروف) ===== */
    const csv_PATH = './data.csv';  // file next to index.html

    /* ===== إعدادات ===== */
    const REQUIRED_NAME_HEADER = 'الاسم';         // إلزامًا نبحث في هذا العمود
    const FALLBACK_NAME_HEADERS = ['name','Name']; // احتياط إن اختلفت
    const MAX_RENDER = 5000;

    /* ===== أدوات عربية ===== */
    function normalizeArabic(str){ if(!str) return ''; return str.toLowerCase().normalize('NFKD')
      .replace(/[\u064B-\u0652]/g,'') // إزالة التشكيل
      .replace(/ـ/g,'')               // إزالة التطويل
      .replace(/[آأإ]/g,'ا')          // توحيد الألف
      .replace(/ى/g,'ي')              // توحيد الياء/الألف المقصورة
      .replace(/\s+/g,' ').trim(); }
    function tokenize(q){ return normalizeArabic(q).split(' ').filter(Boolean); }
    function containsAllTokens(haystack, tokens){ const h = normalizeArabic(haystack||''); return tokens.every(t=>h.includes(t)); }

    /* ===== DOM ===== */
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const alerts = document.getElementById('alerts');
    const feedback = document.getElementById('feedback');
    const emptyMsg = document.getElementById('emptyMsg');
    const qEl = document.getElementById('q');
    const countEl = document.getElementById('count');
    const btnSearch = document.getElementById('btnSearch');
    const btnClear = document.getElementById('btnClear');

    function setError(msg){ alerts.innerHTML = `<div class="error">${msg}</div>`; }
    function clearAlerts(){ alerts.innerHTML = ''; }

    /* ===== اكتشاف الفاصل: ، أو ؛ أو Tab ===== */
    function detectDelimiter(sampleLine){
      const candidates = [',',';','\t'];
      let best = ',', bestCount = 0;
      for(const d of candidates){
        const c = sampleLine.split(d).length;
        if(c > bestCount){ bestCount = c; best = d; }
      }
      return best;
    }

    /* ===== Parsing كله مرة واحدة (ملف صغير) ===== */
    function stripBOM(text){ return text.charCodeAt(0) === 0xFEFF ? text.slice(1) : text; }

    function parseCSV(text){
      text = stripBOM(text);
      const firstNL = text.indexOf('\n');
      const firstLine = firstNL >= 0 ? text.slice(0, firstNL) : text;
      const delimiter = detectDelimiter(firstLine);

      const rows=[]; let row=[]; let field=''; let inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(inQ){
          if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else { inQ=false; } }
          else field+=c;
        } else {
          if(c==='"') inQ=true;
          else if(c===delimiter){ row.push(field); field=''; }
          else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
          else if(c==='\r'){}
          else field+=c;
        }
      }
      row.push(field);
      if(!(row.length===1 && row[0]==='')) rows.push(row);
      return rows;
    }

    /* ===== حالة عامة ===== */
    let HEADERS=[], ROWS=[], nameIdx=-1;
    let sortState = { col: 0, dir: 'asc' };

    function findNameIndex(headers){
      const exact = headers.findIndex(h => (h||'').trim() === REQUIRED_NAME_HEADER);
      if (exact !== -1) return exact;
      for (let i=0;i<headers.length;i++){
        if (FALLBACK_NAME_HEADERS.includes((headers[i]||'').trim())) return i;
      }
      return -1; // نريد نبلغ المستخدم لو ما لقيناه
    }

    function renderHeader(){
      thead.innerHTML = '';
      const tr = document.createElement('tr');
      HEADERS.forEach((h,i)=>{
        const th = document.createElement('th');
        th.textContent = h || '(بدون عنوان)';
        th.title = 'انقر للفرز';
        th.addEventListener('click', ()=>{
          if(sortState.col===i){ sortState.dir = (sortState.dir==='asc') ? 'desc':'asc'; }
          else { sortState.col=i; sortState.dir='asc'; }
          applySearch();
        });
        if(sortState.col===i) th.textContent += sortState.dir==='asc' ? ' ▲' : ' ▼';
        tr.appendChild(th);
      });
      thead.appendChild(tr);
    }

    function naturalCompare(a,b){
      const av=(a??'').toString().trim(), bv=(b??'').toString().trim();
      const an=Number(av), bn=Number(bv);
      const aNum=!Number.isNaN(an)&&av!==''&&av===String(an);
      const bNum=!Number.isNaN(bn)&&bv!==''&&bv===String(bn);
      if(aNum&&bNum) return an-bn;
      return av.localeCompare(bv,'ar',{numeric:true, sensitivity:'base'});
    }

    function renderBody(rows){
      tbody.innerHTML = '';
      emptyMsg.style.display = 'none';
      const toRender = rows.slice(0, MAX_RENDER);
      const frag = document.createDocumentFragment();
      for(const r of toRender){
        const tr = document.createElement('tr');
        for(let i=0;i<HEADERS.length;i++){
          const td = document.createElement('td');
          td.textContent = (r[i] ?? '').toString();
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
      const extra = rows.length - toRender.length;
      feedback.textContent = extra>0
        ? `عُرض ${toRender.length} من ${rows.length} صف (مخفي ${extra} لتسريع الصفحة)`
        : (rows.length ? `عدد النتائج: ${rows.length}` : '');
      countEl.textContent = rows.length ? rows.length.toLocaleString('ar-IQ') : '—';
      if(rows.length === 0) emptyMsg.style.display = 'block';
    }

    function applySearch(){
      const tokens = tokenize(qEl.value||'');
      if(tokens.length===0){ renderBody([]); renderHeader(); return; }

      let filtered = ROWS.filter(r => containsAllTokens(r[nameIdx], tokens));
      // فرز
      filtered = filtered.slice().sort((a,b)=>{
        const cmp = naturalCompare(a[sortState.col], b[sortState.col]);
        return sortState.dir==='asc' ? cmp : -cmp;
      });

      renderHeader();
      renderBody(filtered);
    }

    async function loadCSV(){
      try{
        feedback.textContent = 'جاري التحميل من data.CSV…';
        const res = await fetch(CSV_PATH, { cache:'no-store' });
        if(!res.ok) throw new Error('تعذر تحميل الملف "data.CSV". تأكد أنه بجوار index.html وبنفس حروف الاسم.');
        const text = await res.text();
        const rows = parseCSV(text);
        if(!rows.length) throw new Error('الملف فارغ.');
        HEADERS = (rows[0]||[]).map(h => (h??'').toString().trim());
        ROWS = rows.slice(1);

        // اكتشاف عمود "الاسم"
        nameIdx = findNameIndex(HEADERS);
        if(nameIdx === -1){
          setError('لم أجد عمودًا باسم "الاسم". رجاءً تأكد من عنوان العمود في أول صف.');
          renderHeader(); renderBody([]); return;
        }

        // اجعل الفرز الافتراضي على عمود الاسم
        sortState = { col: nameIdx, dir: 'asc' };

        renderHeader();
        renderBody([]); // لا نعرض شيئًا حتى يكتب المستخدم
        feedback.textContent = `تم التحميل. الأعمدة: ${HEADERS.join(' | ')}`;
      }catch(e){
        setError(e.message || 'حدث خطأ أثناء التحميل.');
      }
    }

    // أحداث
    let t;
    qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); applySearch(); } });
    qEl.addEventListener('input', ()=>{ clearTimeout(t); t = setTimeout(applySearch, 250); });
    btnSearch.addEventListener('click', applySearch);
    btnClear.addEventListener('click', ()=>{ qEl.value=''; applySearch(); qEl.focus(); });

    // بدء
    loadCSV();
  </script>
</body>
</html>


