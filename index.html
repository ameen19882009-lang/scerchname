<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>بحث بالأسماء (CSV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root {
    --accent:#2563eb; --bg:#ffffff; --fg:#111827; --muted:#6b7280;
    --border:#e5e7eb; --hover:#f9fafb; --head:#1f2937; --headfg:#ffffff;
    --row1:#ffffff; --row2:#fcfcff;
  }

  * {
    box-sizing: border-box;
    max-width: 100%;      /* أهم شيء: يمنع العناصر تكسر الصفحة */
  }

  body {
    font-family:"Segoe UI",Tahoma,Arial,sans-serif;
    margin:0; padding:16px;
    background:var(--bg); color:var(--fg);
    overflow-x:hidden;    /* يمنع السحب الجانبي */
  }

  .container {
    max-width: 100%;      /* يخلي الصفحة تنضغط */
    margin:0 auto;
  }

  input[type="text"] {
    width: 100%;          /* مهم للهواتف */
    padding:12px;
    font-size:1rem;
  }

  button {
    padding:10px 14px;
    font-size:0.95rem;
    white-space:nowrap;   /* حتى الأزرار ما تتمطط */
  }

  table {
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    background:#fff;
    table-layout: fixed;  /* يمنع تمدد الأعمدة */
  }

  th, td {
    word-break: break-word; /* يكسر الكلام داخل الخلية */
    padding:10px;
  }

  thead th {
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .table-wrap {
    width:100%;
    overflow-x:auto;       /* يسمح بالبهدلة المنظمة بدون تمدد الصفحة */
    border:1px solid var(--border);
    border-radius:10px;
  }

  /* جعل الصفحة كلها مناسبة للموبايل */
  @media (max-width:600px) {
    body { padding:10px; }
    h1 { font-size:1.2rem; }
    .help { font-size:0.9rem; }
    button { padding:8px 12px; font-size:0.85rem; }
    th, td { padding:8px 6px; font-size:0.85rem; }
  }
</style>

</head>
<body>
  <div class="container">
    <h1>بحث بالأسماء (CSV)</h1>
    <p class="help">
      اكتب اسم ثنائي/جزئي. البحث يتم على عمود <code>الاسم</code> تحديدًا، ويعرض فقط النتائج المطابقة. إذا البحث فارغ لن تُعرض بيانات.
    </p>

    <div id="alerts"></div>

    <div class="bar">
      <label for="q" class="sr">ابحث بالاسم</label>
      <input id="q" type="text" placeholder="ابحث بالاسم (مثال: علي محمد)" autocomplete="off" />
      <button id="btnSearch" type="button">بحث</button>
      <button id="btnClear" class="secondary" type="button">مسح</button>
      <span id="count" class="badge" aria-live="polite">—</span>
    </div>

    <div id="feedback" class="status"></div>

    <div class="table-wrap">
      <table id="grid" aria-live="polite">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="emptyMsg" class="no-results">لا توجد نتائج مطابقة.</div>
  </div>

  <script>
    /* ===== تعريف واضح للمسار: عدّل هنا إذا احتجت ===== */
    const CSV_PATH = './data.csv';   // ← ملفك الحالي

    /* ===== إعدادات ===== */
    const REQUIRED_NAME_HEADER = 'الاسم';        // نبحث حصراً بهذا العمود
    const FALLBACK_NAME_HEADERS = ['name','Name']; // احتياط
    const MAX_RENDER = 5000;

    /* ===== أدوات عربية ===== */
    function normalizeArabic(str){ if(!str) return ''; return str.toLowerCase().normalize('NFKD')
      .replace(/[\u064B-\u0652]/g,'').replace(/ـ/g,'').replace(/[آأإ]/g,'ا').replace(/ى/g,'ي')
      .replace(/\s+/g,' ').trim(); }
    function tokenize(q){ return normalizeArabic(q).split(' ').filter(Boolean); }
    function containsAllTokens(haystack, tokens){ const h=normalizeArabic(haystack||''); return tokens.every(t=>h.includes(t)); }

    /* ===== DOM ===== */
    const thead=document.getElementById('thead'), tbody=document.getElementById('tbody');
    const alerts=document.getElementById('alerts'), feedback=document.getElementById('feedback'), emptyMsg=document.getElementById('emptyMsg');
    const qEl=document.getElementById('q'), countEl=document.getElementById('count');
    const btnSearch=document.getElementById('btnSearch'), btnClear=document.getElementById('btnClear');

    function setError(msg){ alerts.innerHTML=`<div class="error">${msg}</div>`; }
    function clearAlerts(){ alerts.innerHTML=''; }

    /* ===== اكتشاف الفاصل (، ؛ Tab) + Parser يدعم الاقتباس ===== */
    function detectDelimiter(sampleLine){
      const candidates=[',',';','\t']; let best=',', bestCount=0;
      for(const d of candidates){ const c=sampleLine.split(d).length; if(c>bestCount){ bestCount=c; best=d; } }
      return best;
    }
    function stripBOM(text){ return text.charCodeAt(0)===0xFEFF ? text.slice(1) : text; }
    function parseCSV(text){
      text=stripBOM(text);
      const firstNL=text.indexOf('\n'); const firstLine=firstNL>=0? text.slice(0,firstNL):text;
      const delimiter=detectDelimiter(firstLine);

      const rows=[]; let row=[], field='', inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(inQ){
          if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else { inQ=false; } }
          else field+=c;
        } else {
          if(c==='"') inQ=true;
          else if(c===delimiter){ row.push(field); field=''; }
          else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
          else if(c==='\r'){}
          else field+=c;
        }
      }
      row.push(field);
      if(!(row.length===1 && row[0]==='')) rows.push(row);
      return rows;
    }

    /* ===== حالة عامة ===== */
    let HEADERS=[], ROWS=[], nameIdx=-1;
    let sortState={ col:0, dir:'asc' };

    function findNameIndex(headers){
      const exact=headers.findIndex(h => (h||'').trim()===REQUIRED_NAME_HEADER);
      if(exact!==-1) return exact;
      for(let i=0;i<headers.length;i++){
        if(FALLBACK_NAME_HEADERS.includes((headers[i]||'').trim())) return i;
      }
      return -1;
    }

    function renderHeader(){
      thead.innerHTML=''; const tr=document.createElement('tr');
      HEADERS.forEach((h,i)=>{
        const th=document.createElement('th'); th.textContent=h||'(بدون عنوان)'; th.title='انقر للفرز';
        th.addEventListener('click', ()=>{ if(sortState.col===i){ sortState.dir=(sortState.dir==='asc')?'desc':'asc'; } else { sortState.col=i; sortState.dir='asc'; } applySearch(); });
        if(sortState.col===i) th.textContent += sortState.dir==='asc' ? ' ▲' : ' ▼';
        tr.appendChild(th);
      });
      thead.appendChild(tr);
    }

    function naturalCompare(a,b){
      const av=(a??'').toString().trim(), bv=(b??'').toString().trim();
      const an=Number(av), bn=Number(bv); const aNum=!Number.isNaN(an)&&av!==''&&av===String(an); const bNum=!Number.isNaN(bn)&&bv!==''&&bv===String(bn);
      if(aNum&&bNum) return an-bn;
      return av.localeCompare(bv,'ar',{numeric:true, sensitivity:'base'});
    }

    function renderBody(rows){
      tbody.innerHTML=''; emptyMsg.style.display='none';
      const toRender=rows.slice(0,MAX_RENDER); const frag=document.createDocumentFragment();
      for(const r of toRender){
        const tr=document.createElement('tr');
        for(let i=0;i<HEADERS.length;i++){ const td=document.createElement('td'); td.textContent=(r[i]??'').toString(); tr.appendChild(td); }
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
      const extra=rows.length-toRender.length;
      feedback.textContent = extra>0? `عُرض ${toRender.length} من ${rows.length} صف (مخفي ${extra})` : (rows.length? `عدد النتائج: ${rows.length}` : '');
      countEl.textContent = rows.length? rows.length.toLocaleString('ar-IQ') : '—';
      if(rows.length===0) emptyMsg.style.display='block';
    }

    function applySearch(){
      const tokens=tokenize(qEl.value||'');
      if(tokens.length===0){ renderBody([]); renderHeader(); return; }

      let filtered=ROWS.filter(r=>containsAllTokens(r[nameIdx], tokens));
      filtered=filtered.slice().sort((a,b)=>{ const cmp=naturalCompare(a[sortState.col], b[sortState.col]); return sortState.dir==='asc'? cmp : -cmp; });

      renderHeader(); renderBody(filtered);
    }

    async function loadCSV(){
      try{
        feedback.textContent = `جاري التحميل من ${CSV_PATH}…`;
        const res=await fetch(CSV_PATH,{cache:'no-store'});
        if(!res.ok) throw new Error(`تعذر تحميل الملف: ${CSV_PATH}`);
        const text=await res.text();
        const rows=parseCSV(text);
        if(!rows.length) throw new Error('الملف فارغ.');
        HEADERS=(rows[0]||[]).map(h=>(h??'').toString().trim());
        ROWS=rows.slice(1);

        nameIdx=findNameIndex(HEADERS);
        if(nameIdx===-1){
          setError('لم أجد عمودًا باسم "الاسم". عدّل عنوان العمود في أول صف (أو غيّر REQUIRED_NAME_HEADER في الكود).');
          renderHeader(); renderBody([]); return;
        }

        sortState={ col:nameIdx, dir:'asc' };
        clearAlerts(); renderHeader(); renderBody([]); // لا نعرض حتى يكتب المستخدم
        feedback.textContent=`الأعمدة: ${HEADERS.join(' | ')}`;
      }catch(e){
        setError(e.message || 'حدث خطأ أثناء التحميل. تأكد أن الملف اسمه <b>data.csv</b> وبجانب index.html، ثم حدّث الصفحة (Ctrl+F5).');
      }
    }

    // أحداث
    let t; qEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); applySearch(); }});
    qEl.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(applySearch,250); });
    btnSearch.addEventListener('click', applySearch);
    btnClear.addEventListener('click', ()=>{ qEl.value=''; applySearch(); qEl.focus(); });

    // بدء
    loadCSV();
  </script>
</body>
</html>

