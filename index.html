<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (CSV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />


<!-- ğŸ”§ Ø¥Ø¶Ø§ÙØ§Øª Responsive ØªÙÙ„ØµÙ‚ ÙÙˆÙ‚ Ø³ØªØ§ÙŠÙ„Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
<style>
  /* ØªÙ…Ù†Ø¹ Ø£ÙŠ Ø¹Ù†ØµØ± ÙŠØªÙ…Ø¯Ø¯ Ø®Ø§Ø±Ø¬ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© ÙˆÙŠØµÙ†Ø¹ ÙØ±Ø§ØºØ§Øª */
  html, body {
    max-width: 100%;
    overflow-x: hidden; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
  }

  /* Ø¹Ù†Ø§ØµØ± Ø¹Ø§Ù…Ø©: Ø®ÙÙ„Ù‘ÙŠ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ø§ ØªØªØ¬Ø§ÙˆØ² Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© */
  *, *::before, *::after {
    box-sizing: border-box;
    max-width: 100%;
  }

  /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù„Ù„Ø¨Ø­Ø« ÙŠÙƒÙˆÙ† Ù…Ø±ØªØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  .bar {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .bar input[type="text"] {
    flex: 1 1 100%;
    width: 100%;           /* Ø­ØªÙ‰ â€œÙ…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«â€ ÙŠÙ…Ù„Ø£ Ø§Ù„Ø¹Ø±Ø¶ */
    min-width: 0;          /* ÙŠÙ…Ù†Ø¹ ØªÙ…Ø¯Ø¯ ØºØ±ÙŠØ¨ */
  }
  .bar button {
    white-space: nowrap;   /* Ø§Ù„Ø²Ø± Ù…Ø§ ÙŠÙ†ÙƒØ³Ø± Ù„Ø³Ø·Ø±ÙŠÙ† */
  }

  /* ØªØºÙ„ÙŠÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„: ÙŠØ³Ù…Ø­ Ø¨Ø³ÙƒØ±ÙˆÙ„ Ø£ÙÙ‚ÙŠ â€œØ¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„â€ Ù„Ø§ Ø§Ù„ØµÙØ­Ø© */
  .table-wrap {
    width: 100%;
    overflow-x: auto;      /* Ù„Ùˆ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙƒØ«ÙŠØ±Ø©ØŒ Ø§Ù„ØªÙ…Ø±ÙŠØ± ÙÙ‚Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    -webkit-overflow-scrolling: touch; /* Ø³Ù„Ø§Ø³Ø© Ø¹Ù„Ù‰ iOS */
  }

  /* Ø§Ù„Ø¬Ø¯ÙˆÙ„: Ø§Ø¬Ø¨Ø± Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙŠÙ‘Ù ÙˆÙƒØ³Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© */
  table {
    width: 100%;
    table-layout: fixed;   /* ÙŠÙ…Ù†Ø¹ ØªÙ…Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆÙŠÙØ±Ø¶ ØªÙˆØ²ÙŠØ¹ Ù…ØªØ²Ù† */
    border-collapse: separate; /* Ø§ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ ÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ Ù„Ùˆ Ù…ØºÙŠØ± */
  }
  th, td {
    word-break: break-word;   /* ÙƒØ³Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø·ÙˆÙŠÙ„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ù„ÙŠØ© */
  }

  /* Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ¨Ù‚Ù‰ Ø«Ø§Ø¨Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù„Ø§ ÙŠØ®ØªÙÙŠ) */
  thead th {
    position: sticky;
    top: 0;
    z-index: 2;
  }

  /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© ÙÙ‚Ø· */
  @media (max-width: 600px) {
    body { padding: 10px; }       /* ØªÙ‚Ù„ÙŠÙ„ Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    h1   { font-size: 1.1rem; }   /* ØªØµØºÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    .help{ font-size: 0.9rem; }

    th, td {
      padding: 8px 6px;           /* Ø®Ù„Ø§ÙŠØ§ Ø£Ù†Ø­Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
      font-size: 0.9rem;
    }

    /* Ø®ÙÙ‘Ø¶ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø­ÙˆÙ„ Ø§Ù„Ø´Ø±ÙŠØ· */
    .bar { gap: 6px; margin-bottom: 10px; }
    .bar button { padding: 8px 12px; font-size: 0.9rem; }
  }
</style>

</head>
<body>
  <div class="container">
    <h1>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (CSV)</h1>
    <p class="help">
      Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø«Ù†Ø§Ø¦ÙŠ/Ø¬Ø²Ø¦ÙŠ. Ø§Ù„Ø¨Ø­Ø« ÙŠØªÙ… Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ <code>Ø§Ù„Ø§Ø³Ù…</code> ØªØ­Ø¯ÙŠØ¯Ù‹Ø§ØŒ ÙˆÙŠØ¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©. Ø¥Ø°Ø§ Ø§Ù„Ø¨Ø­Ø« ÙØ§Ø±Øº Ù„Ù† ØªÙØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª.
    </p>

    <div id="alerts"></div>

    <div class="bar">
      <label for="q" class="sr">Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
      <input id="q" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ø§Ù„: Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯)" autocomplete="off" />
      <button id="btnSearch" type="button">Ø¨Ø­Ø«</button>
      <button id="btnClear" class="secondary" type="button">Ù…Ø³Ø­</button>
      <span id="count" class="badge" aria-live="polite">â€”</span>
    </div>

    <div id="feedback" class="status"></div>

    <div class="table-wrap">
      <table id="grid" aria-live="polite">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="emptyMsg" class="no-results">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>
  </div>

  <script>
    /* ===== ØªØ¹Ø±ÙŠÙ ÙˆØ§Ø¶Ø­ Ù„Ù„Ù…Ø³Ø§Ø±: Ø¹Ø¯Ù‘Ù„ Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø§Ø­ØªØ¬Øª ===== */
    const CSV_PATH = './data.csv';   // â† Ù…Ù„ÙÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ

    /* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ===== */
    const REQUIRED_NAME_HEADER = 'Ø§Ù„Ø§Ø³Ù…';        // Ù†Ø¨Ø­Ø« Ø­ØµØ±Ø§Ù‹ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯
    const FALLBACK_NAME_HEADERS = ['name','Name']; // Ø§Ø­ØªÙŠØ§Ø·
    const MAX_RENDER = 5000;

    /* ===== Ø£Ø¯ÙˆØ§Øª Ø¹Ø±Ø¨ÙŠØ© ===== */
    function normalizeArabic(str){ if(!str) return ''; return str.toLowerCase().normalize('NFKD')
      .replace(/[\u064B-\u0652]/g,'').replace(/Ù€/g,'').replace(/[Ø¢Ø£Ø¥]/g,'Ø§').replace(/Ù‰/g,'ÙŠ')
      .replace(/\s+/g,' ').trim(); }
    function tokenize(q){ return normalizeArabic(q).split(' ').filter(Boolean); }
    function containsAllTokens(haystack, tokens){ const h=normalizeArabic(haystack||''); return tokens.every(t=>h.includes(t)); }

    /* ===== DOM ===== */
    const thead=document.getElementById('thead'), tbody=document.getElementById('tbody');
    const alerts=document.getElementById('alerts'), feedback=document.getElementById('feedback'), emptyMsg=document.getElementById('emptyMsg');
    const qEl=document.getElementById('q'), countEl=document.getElementById('count');
    const btnSearch=document.getElementById('btnSearch'), btnClear=document.getElementById('btnClear');

    function setError(msg){ alerts.innerHTML=`<div class="error">${msg}</div>`; }
    function clearAlerts(){ alerts.innerHTML=''; }

    /* ===== Ø§ÙƒØªØ´Ø§Ù Ø§Ù„ÙØ§ØµÙ„ (ØŒ Ø› Tab) + Parser ÙŠØ¯Ø¹Ù… Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³ ===== */
    function detectDelimiter(sampleLine){
      const candidates=[',',';','\t']; let best=',', bestCount=0;
      for(const d of candidates){ const c=sampleLine.split(d).length; if(c>bestCount){ bestCount=c; best=d; } }
      return best;
    }
    function stripBOM(text){ return text.charCodeAt(0)===0xFEFF ? text.slice(1) : text; }
    function parseCSV(text){
      text=stripBOM(text);
      const firstNL=text.indexOf('\n'); const firstLine=firstNL>=0? text.slice(0,firstNL):text;
      const delimiter=detectDelimiter(firstLine);

      const rows=[]; let row=[], field='', inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(inQ){
          if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else { inQ=false; } }
          else field+=c;
        } else {
          if(c==='"') inQ=true;
          else if(c===delimiter){ row.push(field); field=''; }
          else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
          else if(c==='\r'){}
          else field+=c;
        }
      }
      row.push(field);
      if(!(row.length===1 && row[0]==='')) rows.push(row);
      return rows;
    }

    /* ===== Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø© ===== */
    let HEADERS=[], ROWS=[], nameIdx=-1;
    let sortState={ col:0, dir:'asc' };

    function findNameIndex(headers){
      const exact=headers.findIndex(h => (h||'').trim()===REQUIRED_NAME_HEADER);
      if(exact!==-1) return exact;
      for(let i=0;i<headers.length;i++){
        if(FALLBACK_NAME_HEADERS.includes((headers[i]||'').trim())) return i;
      }
      return -1;
    }

    function renderHeader(){
      thead.innerHTML=''; const tr=document.createElement('tr');
      HEADERS.forEach((h,i)=>{
        const th=document.createElement('th'); th.textContent=h||'(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)'; th.title='Ø§Ù†Ù‚Ø± Ù„Ù„ÙØ±Ø²';
        th.addEventListener('click', ()=>{ if(sortState.col===i){ sortState.dir=(sortState.dir==='asc')?'desc':'asc'; } else { sortState.col=i; sortState.dir='asc'; } applySearch(); });
        if(sortState.col===i) th.textContent += sortState.dir==='asc' ? ' â–²' : ' â–¼';
        tr.appendChild(th);
      });
      thead.appendChild(tr);
    }

    function naturalCompare(a,b){
      const av=(a??'').toString().trim(), bv=(b??'').toString().trim();
      const an=Number(av), bn=Number(bv); const aNum=!Number.isNaN(an)&&av!==''&&av===String(an); const bNum=!Number.isNaN(bn)&&bv!==''&&bv===String(bn);
      if(aNum&&bNum) return an-bn;
      return av.localeCompare(bv,'ar',{numeric:true, sensitivity:'base'});
    }

    function renderBody(rows){
      tbody.innerHTML=''; emptyMsg.style.display='none';
      const toRender=rows.slice(0,MAX_RENDER); const frag=document.createDocumentFragment();
      for(const r of toRender){
        const tr=document.createElement('tr');
        for(let i=0;i<HEADERS.length;i++){ const td=document.createElement('td'); td.textContent=(r[i]??'').toString(); tr.appendChild(td); }
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
      const extra=rows.length-toRender.length;
      feedback.textContent = extra>0? `Ø¹ÙØ±Ø¶ ${toRender.length} Ù…Ù† ${rows.length} ØµÙ (Ù…Ø®ÙÙŠ ${extra})` : (rows.length? `Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${rows.length}` : '');
      countEl.textContent = rows.length? rows.length.toLocaleString('ar-IQ') : 'â€”';
      if(rows.length===0) emptyMsg.style.display='block';
    }

    function applySearch(){
      const tokens=tokenize(qEl.value||'');
      if(tokens.length===0){ renderBody([]); renderHeader(); return; }

      let filtered=ROWS.filter(r=>containsAllTokens(r[nameIdx], tokens));
      filtered=filtered.slice().sort((a,b)=>{ const cmp=naturalCompare(a[sortState.col], b[sortState.col]); return sortState.dir==='asc'? cmp : -cmp; });

      renderHeader(); renderBody(filtered);
    }

    async function loadCSV(){
      try{
        feedback.textContent = `Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† ${CSV_PATH}â€¦`;
        const res=await fetch(CSV_PATH,{cache:'no-store'});
        if(!res.ok) throw new Error(`ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${CSV_PATH}`);
        const text=await res.text();
        const rows=parseCSV(text);
        if(!rows.length) throw new Error('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº.');
        HEADERS=(rows[0]||[]).map(h=>(h??'').toString().trim());
        ROWS=rows.slice(1);

        nameIdx=findNameIndex(HEADERS);
        if(nameIdx===-1){
          setError('Ù„Ù… Ø£Ø¬Ø¯ Ø¹Ù…ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ø³Ù… "Ø§Ù„Ø§Ø³Ù…". Ø¹Ø¯Ù‘Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙÙŠ Ø£ÙˆÙ„ ØµÙ (Ø£Ùˆ ØºÙŠÙ‘Ø± REQUIRED_NAME_HEADER ÙÙŠ Ø§Ù„ÙƒÙˆØ¯).');
          renderHeader(); renderBody([]); return;
        }

        sortState={ col:nameIdx, dir:'asc' };
        clearAlerts(); renderHeader(); renderBody([]); // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø­ØªÙ‰ ÙŠÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        feedback.textContent=`Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: ${HEADERS.join(' | ')}`;
      }catch(e){
        setError(e.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù Ø§Ø³Ù…Ù‡ <b>data.csv</b> ÙˆØ¨Ø¬Ø§Ù†Ø¨ index.htmlØŒ Ø«Ù… Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø© (Ctrl+F5).');
      }
    }

    // Ø£Ø­Ø¯Ø§Ø«
    let t; qEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); applySearch(); }});
    qEl.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(applySearch,250); });
    btnSearch.addEventListener('click', applySearch);
    btnClear.addEventListener('click', ()=>{ qEl.value=''; applySearch(); qEl.focus(); });

    // Ø¨Ø¯Ø¡
    loadCSV();
  </script>
</body>
</html>


